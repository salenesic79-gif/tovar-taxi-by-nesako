{% extends 'transport/base.html' %}
{% load static %}

{% block title %}Detalji pošiljke - Tovar Taxi{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">📦 Detalji pošiljke #{{ shipment.reference_number }}</h1>
                <div>
                    <span class="badge badge-{% if shipment.status == 'published' %}success{% elif shipment.status == 'assigned' %}primary{% elif shipment.status == 'in_transit' %}warning{% elif shipment.status == 'delivered' %}info{% else %}secondary{% endif %} badge-lg">
                        {{ shipment.get_status_display }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">🚚 Informacije o transportu</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>📍 Preuzimanje</h6>
                            <p class="mb-1"><strong>{{ shipment.pickup_address }}</strong></p>
                            <p class="text-muted mb-3">
                                {{ shipment.pickup_city }}{% if shipment.pickup_postal_code %}, {{ shipment.pickup_postal_code }}{% endif %}<br>
                                {{ shipment.pickup_country }}
                            </p>
                            <p><strong>Datum:</strong> {{ shipment.pickup_date|date:"d.m.Y H:i" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>🎯 Dostava</h6>
                            <p class="mb-1"><strong>{{ shipment.delivery_address }}</strong></p>
                            <p class="text-muted mb-3">
                                {{ shipment.delivery_city }}{% if shipment.delivery_postal_code %}, {{ shipment.delivery_postal_code }}{% endif %}<br>
                                {{ shipment.delivery_country }}
                            </p>
                            {% if shipment.delivery_date %}
                            <p><strong>Datum:</strong> {{ shipment.delivery_date|date:"d.m.Y H:i" }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">📋 Detalji tereta</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Tip tereta:</strong> {{ shipment.get_cargo_type_display }}</p>
                            <p><strong>Težina:</strong> {{ shipment.weight }} kg</p>
                            {% if shipment.volume %}
                            <p><strong>Zapremina:</strong> {{ shipment.volume }} m³</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <p><strong>Broj paleta:</strong> {{ shipment.pallet_count }}</p>
                            <p><strong>Hitnost:</strong> {{ shipment.get_urgency_display }}</p>
                        </div>
                    </div>
                    {% if shipment.cargo_description %}
                    <div class="mt-3">
                        <strong>Opis tereta:</strong>
                        <p class="mt-2">{{ shipment.cargo_description }}</p>
                    </div>
                    {% endif %}
                    {% if shipment.special_requirements %}
                    <div class="mt-3">
                        <strong>Posebni zahtevi:</strong>
                        <p class="mt-2">{{ shipment.special_requirements }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if offers %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">💼 Ponude prevoznika</h5>
                </div>
                <div class="card-body">
                    {% for offer in offers %}
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">{{ offer.carrier.get_full_name|default:offer.carrier.username }}</h6>
                                <p class="text-muted mb-2">{{ offer.carrier.profile.company_name }}</p>
                                <p class="mb-2"><strong>Vozilo:</strong> {{ offer.vehicle.get_vehicle_type_display }} - {{ offer.vehicle.license_plate }}</p>
                                {% if offer.message %}
                                <p class="mb-2">{{ offer.message }}</p>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <h5 class="text-primary mb-2">{{ offer.price|floatformat:0 }} RSD</h5>
                                {% if offer.is_accepted %}
                                <span class="badge badge-success">Prihvaćena</span>
                                {% elif shipment.shipper == user %}
                                <button class="btn btn-sm btn-primary" onclick="acceptOffer({{ offer.id }})">
                                    Prihvati
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <small class="text-muted">Poslato: {{ offer.created_at|date:"d.m.Y H:i" }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">💰 Cena i plaćanje</h5>
                </div>
                <div class="card-body">
                    <p><strong>Ponuđena cena:</strong></p>
                    <h4 class="text-success">{{ shipment.offered_price|floatformat:0 }} RSD</h4>
                    {% if shipment.final_price %}
                    <p class="mt-3"><strong>Finalna cena:</strong></p>
                    <h5 class="text-primary">{{ shipment.final_price|floatformat:0 }} RSD</h5>
                    {% endif %}
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">👤 Kontakt informacije</h5>
                </div>
                <div class="card-body">
                    <p><strong>Naručilac:</strong> {{ shipment.shipper.get_full_name|default:shipment.shipper.username }}</p>
                    {% if shipment.contact_person %}
                    <p><strong>Kontakt osoba:</strong> {{ shipment.contact_person }}</p>
                    {% endif %}
                    {% if shipment.contact_phone %}
                    <p><strong>Telefon:</strong> {{ shipment.contact_phone }}</p>
                    {% endif %}
                </div>
            </div>

            {% if can_make_offer %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">📝 Pošaljite ponudu</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Zainteresovani ste za ovaj transport?</p>
                    <a href="{% url 'make_offer' shipment.pk %}" class="btn btn-primary btn-block">
                        Pošaljite ponudu
                    </a>
                </div>
            </div>
            {% endif %}

            {% if shipment.shipper == user %}
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">⚙️ Akcije</h5>
                </div>
                <div class="card-body">
                    {% if shipment.status == 'draft' %}
                    <button class="btn btn-success btn-block mb-2" onclick="publishShipment({{ shipment.id }})">
                        Objavi pošiljku
                    </button>
                    {% endif %}
                    <a href="#" class="btn btn-outline-primary btn-block mb-2">Uredi pošiljku</a>
                    {% if shipment.status in 'draft,published' %}
                    <button class="btn btn-outline-danger btn-block" onclick="cancelShipment({{ shipment.id }})">
                        Otkaži pošiljku
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function acceptOffer(offerId) {
    if (confirm('Da li ste sigurni da želite da prihvatite ovu ponudu?')) {
        // AJAX call to accept offer
        fetch(`/transport/api/offers/${offerId}/accept/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Greška: ' + data.error);
            }
        });
    }
}

function publishShipment(shipmentId) {
    if (confirm('Da li želite da objavite ovu pošiljku?')) {
        // AJAX call to publish shipment
        fetch(`/transport/api/shipments/${shipmentId}/publish/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Greška: ' + data.error);
            }
        });
    }
}

function cancelShipment(shipmentId) {
    if (confirm('Da li ste sigurni da želite da otkažete ovu pošiljku?')) {
        // AJAX call to cancel shipment
        fetch(`/transport/api/shipments/${shipmentId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Greška: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}
