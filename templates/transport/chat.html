{% extends 'transport/base.html' %}
{% load static %}

{% block title %}Chat - Tura #{{ tura.id }} - Tovar Taxi{% endblock %}

{% block extra_css %}
<style>
.chat-container {
    height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 20px 40px rgba(0,0,0,0.2);
}

.chat-header {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 20px;
    color: white;
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.chat-info {
    display: flex;
    justify-content: between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.route-display {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    font-weight: 500;
}

.contact-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.call-btn {
    background: #25D366;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.call-btn:hover {
    background: #128C7E;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: rgba(255,255,255,0.05);
}

.message {
    margin-bottom: 15px;
    display: flex;
    animation: slideIn 0.3s ease;
}

.message.sent {
    justify-content: flex-end;
}

.message.received {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 18px;
    border-radius: 20px;
    position: relative;
    word-wrap: break-word;
}

.message.sent .message-bubble {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 5px;
}

.message.received .message-bubble {
    background: rgba(255,255,255,0.9);
    color: #333;
    border-bottom-left-radius: 5px;
}

.message.system .message-bubble {
    background: rgba(255,193,7,0.9);
    color: #333;
    border-radius: 15px;
    font-style: italic;
    text-align: center;
    max-width: 90%;
    margin: 0 auto;
}

.message-info {
    font-size: 11px;
    opacity: 0.7;
    margin-top: 5px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.message-time {
    font-size: 10px;
    opacity: 0.6;
}

.location-message {
    background: #17a2b8;
    color: white;
    padding: 15px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-input {
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 20px;
    border-top: 1px solid rgba(255,255,255,0.2);
}

.input-group {
    display: flex;
    gap: 10px;
    align-items: flex-end;
}

.message-input {
    flex: 1;
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 25px;
    padding: 12px 20px;
    font-size: 14px;
    resize: none;
    min-height: 45px;
    max-height: 120px;
}

.message-input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
}

.send-btn {
    background: #28a745;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.send-btn:hover {
    background: #218838;
    transform: scale(1.1);
}

.send-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.attachment-btn {
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.attachment-btn:hover {
    background: #5a6268;
    transform: scale(1.1);
}

.location-btn {
    background: #17a2b8;
    color: white;
    border: none;
    border-radius: 50%;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.location-btn:hover {
    background: #138496;
    transform: scale(1.1);
}

.typing-indicator {
    display: none;
    padding: 10px 20px;
    font-style: italic;
    opacity: 0.7;
    color: white;
}

.typing-dots {
    display: inline-block;
    animation: typing 1.5s infinite;
}

@keyframes typing {
    0%, 60%, 100% { opacity: 0.3; }
    30% { opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.status-indicator {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-left: 5px;
}

.status-online { background: #28a745; }
.status-offline { background: #6c757d; }

.unread-count {
    background: #dc3545;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 10px;
    font-weight: bold;
    margin-left: 5px;
}

@media (max-width: 768px) {
    .chat-container {
        height: calc(100vh - 150px);
    }
    
    .chat-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .message-bubble {
        max-width: 85%;
    }
    
    .input-group {
        flex-wrap: wrap;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h4 mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Chat - Tura #{{ tura.id }}
                </h1>
                <a href="{% url 'ture_list' %}" class="btn btn-outline-primary">
                    <i class="fas fa-arrow-left me-2"></i>Nazad na ture
                </a>
            </div>

            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-info">
                        <div class="route-display">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ tura.pocetna_adresa }}</span>
                            <i class="fas fa-arrow-right mx-2"></i>
                            <i class="fas fa-flag"></i>
                            <span>{{ tura.odredisna_adresa }}</span>
                        </div>
                        <div class="contact-info">
                            <div>
                                <i class="fas fa-user me-2"></i>
                                <strong>{{ other_user.get_full_name }}</strong>
                                <span class="status-indicator status-online" title="Online"></span>
                            </div>
                            <button class="call-btn" onclick="initiateCall()">
                                <i class="fas fa-phone"></i>
                                Pozovi
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chatMessages">
                    {% for poruka in poruke %}
                        <div class="message {% if poruka.sender == request.user %}sent{% elif poruka.message_type == 'system' %}system{% else %}received{% endif %}">
                            <div class="message-bubble">
                                {% if poruka.message_type == 'text' or poruka.message_type == 'system' %}
                                    {{ poruka.text_content }}
                                {% elif poruka.message_type == 'location' %}
                                    <div class="location-message">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <div>
                                            <strong>Lokacija poslana</strong><br>
                                            <small>Lat: {{ poruka.location_lat }}, Lng: {{ poruka.location_lng }}</small>
                                        </div>
                                        <a href="https://maps.google.com/?q={{ poruka.location_lat }},{{ poruka.location_lng }}" target="_blank" class="btn btn-sm btn-light">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                {% elif poruka.message_type == 'image' %}
                                    <img src="{{ poruka.image_content.url }}" alt="Slika" style="max-width: 100%; border-radius: 10px;">
                                    {% if poruka.text_content %}
                                        <div class="mt-2">{{ poruka.text_content }}</div>
                                    {% endif %}
                                {% endif %}
                                
                                {% if poruka.message_type != 'system' %}
                                <div class="message-info">
                                    <span class="message-time">{{ poruka.created_at|date:"H:i" }}</span>
                                    {% if poruka.sender == request.user %}
                                        <i class="fas fa-check{% if poruka.is_read %}-double text-info{% endif %}" title="{% if poruka.is_read %}Pročitano{% else %}Poslano{% endif %}"></i>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center text-white-50 mt-5">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <p>Još nema poruka. Pošaljite prvu poruku!</p>
                        </div>
                    {% endfor %}
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <span class="typing-dots">{{ other_user.get_full_name }} kuca...</span>
                </div>

                <!-- Chat Input -->
                <div class="chat-input">
                    <div class="input-group">
                        <button class="attachment-btn" onclick="selectFile()" title="Pošalji sliku">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="location-btn" onclick="sendLocation()" title="Pošalji lokaciju">
                            <i class="fas fa-map-marker-alt"></i>
                        </button>
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Ukucajte poruku..."
                            rows="1"
                            onkeypress="handleKeyPress(event)"
                            oninput="handleTyping()"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden file input -->
<input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="handleFileSelect(event)">
{% endblock %}

{% block extra_js %}
<script>
const turaId = {{ tura.id }};
const currentUserId = {{ request.user.id }};
let typingTimer;
let isTyping = false;

// Auto-resize textarea
document.getElementById('messageInput').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
});

// Handle Enter key
function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// Send message
function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = true;
    
    fetch(`/api/chat/${turaId}/posalji/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            message_type: 'text',
            text_content: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            messageInput.style.height = 'auto';
            loadMessages();
        } else {
            showNotification('Greška pri slanju poruke: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Greška:', error);
        showNotification('Greška pri slanju poruke', 'error');
    })
    .finally(() => {
        sendBtn.disabled = false;
    });
}

// Send location
function sendLocation() {
    if (!navigator.geolocation) {
        showNotification('Geolokacija nije podržana u vašem browseru', 'error');
        return;
    }
    
    showNotification('Dobijanje lokacije...', 'info');
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            fetch(`/api/chat/${turaId}/posalji/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message_type: 'location',
                    location_lat: lat,
                    location_lng: lng,
                    text_content: 'Moja trenutna lokacija'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMessages();
                    showNotification('Lokacija je poslana', 'success');
                } else {
                    showNotification('Greška pri slanju lokacije: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Greška:', error);
                showNotification('Greška pri slanju lokacije', 'error');
            });
        },
        function(error) {
            showNotification('Greška pri dobijanju lokacije: ' + error.message, 'error');
        }
    );
}

// File selection
function selectFile() {
    document.getElementById('fileInput').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        showNotification('Molimo odaberite sliku', 'error');
        return;
    }
    
    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showNotification('Slika je prevelika. Maksimalna veličina je 5MB.', 'error');
        return;
    }
    
    // TODO: Implement file upload
    showNotification('Upload slika će biti implementiran uskoro', 'info');
}

// Load messages
function loadMessages() {
    fetch(`/api/chat/${turaId}/poruke/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateChatMessages(data.poruke);
            }
        })
        .catch(error => console.error('Greška pri učitavanju poruka:', error));
}

// Update chat messages
function updateChatMessages(poruke) {
    const chatMessages = document.getElementById('chatMessages');
    const scrollToBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 50;
    
    // Clear existing messages
    chatMessages.innerHTML = '';
    
    if (poruke.length === 0) {
        chatMessages.innerHTML = `
            <div class="text-center text-white-50 mt-5">
                <i class="fas fa-comments fa-3x mb-3"></i>
                <p>Još nema poruka. Pošaljite prvu poruku!</p>
            </div>
        `;
        return;
    }
    
    poruke.forEach(poruka => {
        const messageDiv = document.createElement('div');
        let messageClass = 'message ';
        
        if (poruka.sender_id === currentUserId) {
            messageClass += 'sent';
        } else if (poruka.message_type === 'system') {
            messageClass += 'system';
        } else {
            messageClass += 'received';
        }
        
        messageDiv.className = messageClass;
        
        let messageContent = '';
        if (poruka.message_type === 'text' || poruka.message_type === 'system') {
            messageContent = poruka.text_content;
        } else if (poruka.message_type === 'location') {
            messageContent = `
                <div class="location-message">
                    <i class="fas fa-map-marker-alt"></i>
                    <div>
                        <strong>Lokacija poslana</strong><br>
                        <small>Lat: ${poruka.location_lat}, Lng: ${poruka.location_lng}</small>
                    </div>
                    <a href="https://maps.google.com/?q=${poruka.location_lat},${poruka.location_lng}" target="_blank" class="btn btn-sm btn-light">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                </div>
            `;
        }
        
        const messageTime = new Date(poruka.created_at).toLocaleTimeString('sr-RS', { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${messageContent}
                ${poruka.message_type !== 'system' ? `
                    <div class="message-info">
                        <span class="message-time">${messageTime}</span>
                        ${poruka.sender_id === currentUserId ? `
                            <i class="fas fa-check${poruka.is_read ? '-double text-info' : ''}" title="${poruka.is_read ? 'Pročitano' : 'Poslano'}"></i>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
    });
    
    if (scrollToBottom) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
}

// Handle typing indicator
function handleTyping() {
    // TODO: Implement typing indicator via WebSocket
}

// Initiate call
function initiateCall() {
    // TODO: Implement virtual calling system
    showNotification('Pozivanje će biti implementirano uskoro', 'info');
}

// Utility functions
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showNotification(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
        ${message}
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    
    // Auto-refresh messages every 5 seconds
    setInterval(loadMessages, 5000);
    
    // Scroll to bottom initially
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Focus on input
    document.getElementById('messageInput').focus();
});
</script>
{% endblock %}
